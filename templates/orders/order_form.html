{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Создать заявку</h2>
    <form method="post" id="orderForm">
        {% csrf_token %}
        
        <!-- Поле выбора мастера -->
        <div class="mb-3">
            <label for="{{ form.master.id_for_label }}" class="form-label">Мастер</label>
            {{ form.master }}
        </div>
        
        <!-- Контейнер для динамической загрузки услуг -->
        <div class="mb-3">
            <label class="form-label">Услуги</label>
            <div id="servicesContainer" class="border p-3 rounded">
                {% if form.services.field.queryset.exists %}
                    <div class="row">
                        {% for service in form.services.field.queryset %}
                        <div class="col-md-6 mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" 
                                    name="services" value="{{ service.id }}" 
                                    id="service_{{ service.id }}"
                                    {% if service.id in form.services.value %}checked{% endif %}>
                                <label class="form-check-label" for="service_{{ service.id }}">
                                    {{ service.name }} ({{ service.price }} руб.)
                                </label>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">Сначала выберите мастера</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Остальные поля формы -->
        <div class="mb-3">
            <label for="{{ form.client_name.id_for_label }}" class="form-label">Ваше имя</label>
            {{ form.client_name }}
        </div>
        
        <div class="mb-3">
            <label for="{{ form.phone.id_for_label }}" class="form-label">Телефон</label>
            {{ form.phone }}
        </div>
        
        <div class="mb-3">
            <label for="{{ form.comment.id_for_label }}" class="form-label">Комментарий</label>
            {{ form.comment }}
        </div>
        
        <div class="mb-3">
            <label for="{{ form.appointment_date.id_for_label }}" class="form-label">Дата и время</label>
            {{ form.appointment_date }}
        </div>
        
        <button type="submit" class="btn btn-primary">Отправить заявку</button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    // Обработчик изменения мастера
    $('#id_master').change(function() {
        const masterId = $(this).val();
        const $container = $('#servicesContainer');
        
        if (masterId) {
            // Получаем выбранные услуги (для сохранения состояния)
            const selectedServices = [];
            $container.find('input[type="checkbox"]:checked').each(function() {
                selectedServices.push($(this).val());
            });
            
            // Показываем индикатор загрузки
            $container.html(`
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="mt-2">Загрузка услуг...</p>
                </div>
            `);
            
            // AJAX запрос
            $.ajax({
                url: '/get-services/',
                type: 'GET',
                data: {
                    'master_id': masterId,
                    'selected_services[]': selectedServices
                },
                success: function(response) {
                    $container.html(`
                        <div class="row">
                            ${response.html || '<div class="col-12"><p class="text-muted">Нет доступных услуг</p></div>'}
                        </div>
                    `);
                },
                error: function() {
                    $container.html(`
                        <div class="alert alert-danger">
                            Ошибка загрузки услуг. Пожалуйста, попробуйте еще раз.
                        </div>
                    `);
                }
            });
        } else {
            $container.html('<p class="text-muted">Сначала выберите мастера</p>');
        }
    });
});
</script>
{% endblock %}